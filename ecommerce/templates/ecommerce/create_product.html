{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Product</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        input, select, textarea { display: block; width: 100%; margin-bottom: 15px; padding: 8px; }
        label { font-weight: bold; margin-top: 10px; }
        .preview img { width: 150px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Create Product</h1>

    <form id="productForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <label for="name">Product Name</label>
        <input type="text" id="name" name="name" required>

        <label for="category">Category</label>
        <select id="category" name="category" required>
            <option value="">Select Category</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
        </select>

        <label for="description">Description</label>
        <textarea id="description" name="description" rows="4"></textarea>

        <label for="price">Price</label>
        <input type="number" id="price" name="price" step="0.01" required>

        <label for="stock">Stock</label>
        <input type="number" id="stock" name="stock" required>

        <label for="images">Upload Images (multiple)</label>
        <input type="file" id="images" name="images" multiple accept="image/*">

        <div class="preview" id="preview"></div>

        <button type="submit">Create Product</button>
    </form>

    <div id="message" style="margin-top:20px; font-weight:bold;"></div>

    <script>
        // Show image previews
        const imagesInput = document.getElementById('images');
        const preview = document.getElementById('preview');

        imagesInput.addEventListener('change', () => {
            preview.innerHTML = '';
            const files = imagesInput.files;
            for (let i = 0; i < files.length; i++) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(files[i]);
                preview.appendChild(img);
            }
        });

        // Submit form via JS fetch
        const form = document.getElementById('productForm');
        const message = document.getElementById('message');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();

            // Gather JSON data
            const data = {
                name: document.getElementById('name').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                price: document.getElementById('price').value,
                stock: document.getElementById('stock').value
            };

            formData.append('data', JSON.stringify(data));

            // Append all images
            const files = document.getElementById('images').files;
            for (let i = 0; i < files.length; i++) {
                formData.append('images', files[i]);
            }

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            const response = await fetch("{% url 'products:create_product' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            });

            const result = await response.json();
            if (response.ok) {
                message.style.color = 'green';
                message.innerText = result.message + ' | Product ID: ' + result.product_id;
                form.reset();
                preview.innerHTML = '';
            } else {
                message.style.color = 'red';
                message.innerText = result.error || 'Something went wrong';
            }
        });
    </script>
</body>
</html>
